---
title: "Group Assignment"
author: "Patrick Chang"
date: "28/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(sf)
library(tidyverse)

reef_geomorphic = st_read("/Users/patri/OneDrive/Desktop/DATA3888/MARS_DATA3888_reefC4/Data/reef_geomorphic_joined_all.gpkg")
reef_geomorphic = reef_geomorphic %>% 
  as.data.frame() %>%
  mutate(Date = as.Date(Date, "%d-%b-%y")) %>%
  mutate(Depth = as.numeric(Depth)) %>%
  filter(Depth <= 15) # as per Allen Coral Atlas specs
reef_geomorphic
```

## Investigating NAs

```{r}
not_na = reef_geomorphic %>% 
  slice(which(!is.na(reef_geomorphic$class))) %>%
  select(Reef.ID, Depth, Average_bleaching, class) %>%
  as.data.frame()
not_na # 4545 - still some missing data as we haven't finalised which dataset to use
not_na %>% distinct(Reef.ID, Depth, class) # 3036 - meaning there are some duplicates
not_na %>% distinct(Reef.ID, Depth) # 3036 - meaning that the same reefs but at different depths have the same class identifier, which might be a problem
```

## 

```{r}
#Most recent entry
#Select several attributes for our model
reef_recent = reef_geomorphic %>%
  select(Reef.ID, Date, SSTA_Frequency_Standard_Deviation, Depth, Diversity, class,Average_bleaching) %>% 
  mutate(SSTA_Frequency_Standard_Deviation = as.numeric(SSTA_Frequency_Standard_Deviation),
         Average_bleaching = as.numeric(Average_bleaching),
         Depth = as.numeric(Depth), 
         Diversity = as.numeric(Diversity)) %>%
  group_by(Reef.ID) %>% filter(Date == max(Date))

reef_recent


#Rugosity
reef_recent["rugosity"] <- ifelse(reef_recent$class == "Reef Slope" | reef_recent$class == "Outer Reef Flat","High",
                                 ifelse(reef_recent$class == "Sheltered Reef Slope" | reef_recent$class == "Reef Crest","Medium","Low"))


#bleached or not bleached
reef_recent["bleached"] <- ifelse(reef_recent$Average_bleaching > 0,1,0)


#Remove NA
reef_final <- reef_recent %>% drop_na()

reef_final

reef_model <- glm(formula = bleached ~ SSTA_Frequency_Standard_Deviation + Depth + Diversity + rugosity, data = reef_final, family = binomial)

summary(reef_model)

#Variable selection for logistic regression
step_model_reef = step(reef_model, trace = 0)
summary(step_model_reef)


```

