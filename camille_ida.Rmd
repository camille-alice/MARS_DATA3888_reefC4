---
title: "camille_ida"
author: "Camille Karski"
date: '2022-04-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/camillekarski/Documents/Uni/DATA3888')

library(plyr)
library(tidyverse)
library(tuneR)
library(devtools)
library(ggplot2)
library(tsfeatures)
library(sf)
library(maps)
library(reshape2)
library(viridis)
library(plotly)
library(GGally)
```

## Joining Reef and Geomorphic 

```{r Reading in reef data}
#reading in reef data set ! with variables as sf object using st_read
reef_df =st_read("./DATA3888_data/Reef_Check_with_cortad_variables_with_annual_rate_of_SST_change.csv",
                   options=c("X_POSSIBLE_NAMES=Longitude.Degrees","Y_POSSIBLE_NAMES=Latitude.Degrees"))
#setting reef_df to same CRS 
st_crs(reef_df) = 4326

```

## Extracting data 

The data was downloaded from [Allen Coral Atlas](https://allencoralatlas.org/resources/) in a zip archive. Inside the unzipped file, the structure is: 

-Areaname-YYYYMMDDHHMMSS
  -Benthic-Map
    -benthic.gpkg
  -boundary
    -boundary.gpkg
  -Geomorphic-Map
    -geomorphic.gpkg (!OR .geojson)
  -license and documentation
  -stats
    -statistics.csv

We need to extract all the benthic, boundary, and geomorphic data for each area and create respective shape files. 

```{r Data extraction function}
#function for extracting features from zipped archives 
reef_f_extract = function(file_path,zip_name,feature_path,out_dir, reef_df){
  file_ls = as.character(unzip(paste0(file_path,zip_name), list = TRUE)$Name)
  feature_filename = str_subset(file_ls, feature_path)
  if (length(feature_filename) != 0){
    unzip(paste0(file_path,zip_name), files=feature_filename, exdir = out_dir)
    rugosity_df = st_read(paste0(out_dir, feature_filename))
    sf_use_s2(FALSE)
    reef_join_df = st_join(reef_df, rugosity_df)
    }#end if
  return(reef_join_df)
} #end function
```
```{r Data extraction loop}
# file name containing all data: Global-Dataset-20211006223100
file_path = "./DATA3888_data/Global-Dataset-20211006223100.nosync/"
#creating list of all files in folder 
files = list.files(path=file_path, pattern=".zip$", recursive = F)
#setting new directory for where data will go 
outDir = "./DATA3888_data/geomorphic_all/"
#target file name for extraction 
geom_filepath = "^Geomorphic-Map/geomorphic"
reef_join_df = reef_df

#commented out so as not to run again 
for (i in files) {
  reef_join_df = reef_f_extract(file_path,i,geom_filepath,outDir,reef_join_df)
} 

```

Got up to `Northeastern Asia` before:

Error: Cannot open "/Users/camillekarski/Documents/Uni/DATA3888/DATA3888_data/geomorphic_all/Geomorphic-Map/geomorphic.geojson"; The source could be corrupt or not supported. See `st_drivers()` for a list of supported formats.

```{r Combinded classes and writing to file}
#there is an easier way to do this I am just tired rn
reef_join_c = reef_join_df %>% mutate(class = coalesce(class.x, class.y, class.x.1, class.y.1, class.x.2, class.y.2, class.x.3, class.y.3, class.x.4, class.y.4, class.x.5, class.y.5, class.x.6, class.y.6)) %>%
         select(-class.x, -class.y, -class.x.1, -class.y.1, -class.x.2, -class.y.2, -class.x.3, -class.y.3, -class.x.4, -class.y.4, -class.x.5, -class.y.5, -class.x.6, -class.y.6)

#write to gpkg
st_write(reef_join_c, 'reef_geomorphic_joined.gpkg')
```
Plotting to see the differences on a map in points

```{r Quick vis}
#removing NAs for vis
reef_join_c_NA = reef_join_c %>% drop_na()
world_map = map_data("world")

ggplot() +  
  geom_polygon(data =world_map, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
  geom_sf(data = reef_join_c_NA, aes(colour = class), alpha=0.6) +
  #geom_sf(data = rugosity_df_small, aes(colour = class)) + #commented out as dataset is too large 
  theme_void()

```






